image: golang:latest

stages:
  - test
  - build
  - deploy

# -----------------
# 1. TEST STAGE
# -----------------
format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

# -----------------
# 2. BUILD STAGE (Binaries)
# -----------------
compilebsd:
  stage: build
  variables:
    GOOS: freebsd
    GOARCH: amd64
  script:
    - mkdir -p mybinaries/${GOOS}_${GOARCH}
    - go build -o mybinaries/${GOOS}_${GOARCH} ./...
  artifacts:
    paths:
      - mybinaries

compilelinux:
  stage: build
  variables:
    GOOS: linux
    GOARCH: amd64
  script:
    - mkdir -p mybinaries/${GOOS}_${GOARCH}
    - go build -o mybinaries/${GOOS}_${GOARCH} ./...
  artifacts:
    paths:
      - mybinaries

# -----------------
# 3. DEPLOY STAGE
# -----------------

# JOB A: Standard Master Merge
# Pushes ":latest" and ":<commit-sha>" (e.g. :a1b2c3d)
build_and_push_commit:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    # Base Image Names
    HUB_IMAGE: $DOCKER_HUB_USER/weather-receiver
    OUTPOINT_IMAGE: reg.outpointllc.com/john/weather-receiver
  script:
    # 1. Build with SHA tag (Primary) and 'latest' tag (Secondary)
    - docker build -t $HUB_IMAGE:$CI_COMMIT_SHORT_SHA -t $HUB_IMAGE:latest .

    # 2. Push to Docker Hub (Both tags)
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
    - docker push $HUB_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $HUB_IMAGE:latest
    - docker logout

    # 3. Tag & Push to Outpoint Registry (Both tags)
    - docker tag $HUB_IMAGE:$CI_COMMIT_SHORT_SHA $OUTPOINT_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker tag $HUB_IMAGE:latest $OUTPOINT_IMAGE:latest
    
    - echo "$OUTPOINT_REGISTRY_TOKEN" | docker login reg.outpointllc.com -u "$OUTPOINT_REGISTRY_USER" --password-stdin
    - docker push $OUTPOINT_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $OUTPOINT_IMAGE:latest
    - docker logout reg.outpointllc.com
  
  # Only run on master branch (not on tags)
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "main"

# JOB B: Release Tag
# Pushes ":v1.0.0" (or whatever the git tag is)
build_and_push_release:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    # Base Image Names
    HUB_IMAGE: $DOCKER_HUB_USER/weather-receiver
    OUTPOINT_IMAGE: reg.outpointllc.com/john/weather-receiver
  script:
    # 1. Build using the Git Tag (e.g. v1.0.0)
    - docker build -t $HUB_IMAGE:$CI_COMMIT_TAG .

    # 2. Push to Docker Hub
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
    - docker push $HUB_IMAGE:$CI_COMMIT_TAG
    - docker logout

    # 3. Push to Outpoint Registry
    - docker tag $HUB_IMAGE:$CI_COMMIT_TAG $OUTPOINT_IMAGE:$CI_COMMIT_TAG
    
    - echo "$OUTPOINT_REGISTRY_TOKEN" | docker login reg.outpointllc.com -u "$OUTPOINT_REGISTRY_USER" --password-stdin
    - docker push $OUTPOINT_IMAGE:$CI_COMMIT_TAG
    - docker logout reg.outpointllc.com

  # Only run when a Git Tag is created
  only:
    - tags

include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml